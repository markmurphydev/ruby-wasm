<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ruby-Wasm</title>
</head>
<body>
    <form id="update_length">
        <label>Grid length: <input id="length" type="number" min="0" max="30" value="15"/></label>
    </form>
    <button class="button" onclick="step()">Step</button>
    <button class="button" id="timer" onclick="startPause()">Start</button>
    <pre class="unselectable" id="cells"></pre>
</body>
<style>
    .unselectable {
        /*
        Attribution: From MDN `user-select` page:
            https://developer.mozilla.org/en-US/docs/Web/CSS/user-select
         */
        -webkit-user-select: none; /* Safari */
        user-select: none;
    }
    .button {
        cursor: pointer;
    }
</style>
<script>
    let wasm = null;
    let timer = null;

    const startPause = () => {
        if (timer === null) {
            step();
            timer = setInterval(step, 700);
            document.getElementById("timer").innerText = "Pause"
        } else {
            clearInterval(timer);
            timer = null;
            document.getElementById("timer").innerText = "Start"
        }
    }

    const updateLength = () => {
        let length = document.getElementById("length").value;
        wasm.instance.exports.update_length(length);
        showCells();
    }

    const showCells = () => {
        let cells = wasm.instance.exports.get_cells();
        let res = [];
        cells.forEach((row, rowIdx) => {
            row.forEach((cell, colIdx) => {
                let cellRes = document.createElement("span")
                cellRes.setAttribute("onclick", `toggleCell(${rowIdx}, ${colIdx})`);
                cellRes.setAttribute("style", "cursor: pointer");
                cellRes.innerText = cell === 1n ? "X " : "_ ";
                res.push(cellRes);
            })
            res.push("\n");
        })
        document.getElementById("cells").replaceChildren(...res);
    }

    const toggleCell = (row, col) => {
        wasm.instance.exports.toggle_cell(row, col);
        showCells();
    }

    const step = () => {
        wasm.instance.exports.step();
        showCells();
    }

    const imports = {
        i64: { toRef: (n) => n },
        arr: {
            new: () => [],
            push: (arr, x) => arr.push(x)
        },
    }

    document.getElementById("update_length").addEventListener("submit", (event) => {
        event.preventDefault();
        updateLength();
    })

    addEventListener("load", () => {
        WebAssembly.instantiateStreaming(fetch("ruby.wasm"), imports).then(
            (obj) => {
                wasm = obj
                obj.instance.exports.__ruby_top_level_function();
                obj.instance.exports.toggle_cell(4, 5)
                obj.instance.exports.toggle_cell(5, 6)
                obj.instance.exports.toggle_cell(6, 4)
                obj.instance.exports.toggle_cell(6, 5)
                obj.instance.exports.toggle_cell(6, 6)
                showCells();
            }
        );
    });
</script>
</html>